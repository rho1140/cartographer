<!DOCTYPE html>
<html lang="en">
<head>
  <!--  Grab this code from here, https://leafletjs.com/download.html -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <!--  Library to load the CSV file -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!--  County GeoJSON data -->
  <script src="dev_travis_county.js"></script>
  <style>
    #map {position: absolute; top: 0; bottom: 0; left: 0; right: 0;}
    .precinct-label {
      font-size: 12px;
      font-weight: bold;
      color: black;
      background: none;
      border: none;
      box-shadow: none;
      text-shadow: 1px 1px 2px white;
      pointer-events: none; /* let mouse go through */
    }
  </style>

</head>
<body>
  <div id="map"></div>
  <script>
  // Initialize the map
  var map = L.map('map').setView([30.292242, -97.721990], 11);
  L.tileLayer('https://api.maptiler.com/maps/openstreetmap/{z}/{x}/{y}.jpg?key=***REDACTED***', {
    attribution: '<a href="https://www.maptiler.com/copyright/" target="_blank">&copy; MapTiler</a> <a href="https://www.openstreetmap.org/copyright" target="_blank">&copy; OpenStreetMap contributors</a>',
  }).addTo(map);

  // 1. Load and parse the CSV
  Papa.parse("travis_data.csv", {
    download: true,
    header: true,
    complete: function(results) {
      var csvData = results.data;

      // 2. Create a lookup object: key = precinct number (as string or number)
      var precinctLookup = {};
      csvData.forEach(function(row) {
        var precinctNumber = parseInt(row["Precinct Number"], 10);
        if (!isNaN(precinctNumber)) {
          precinctLookup[precinctNumber] = row;
        }
      });

      // 3. Now add GeoJSON to the map
      var traviscountyLayer = L.geoJSON(traviscountydata, {
        style: function (feature) {
          var precinctNumber = parseInt(feature.properties.PREC, 10);
          var csv = precinctLookup[precinctNumber];
          var hasChair = csv && csv["Precinct Chair Name"] && csv["Precinct Chair Name"].trim() !== "";

          return {
            color: "#3388ff",
            weight: 2,
            fillColor: hasChair ? "#3388ff" : "#ffffff",
            fillOpacity: hasChair ? 0.2 : 0
          };
        },
        onEachFeature: function (feature, layer) {
          // Attach matching CSV data
          var precinctNumber = parseInt(feature.properties.PREC, 10);
          var csvMatch = precinctLookup[precinctNumber];
          feature.properties.csv = csvMatch || {};  // Safe attach

          // Show precinct number as a tooltip
          layer.bindTooltip(`${precinctNumber}`, {
            permanent: true,
            direction: "center",
            className: "precinct-label"
          });

          // Hover effect
          layer.on({
            mouseover: function (e) {
              var layer = e.target;
              layer.setStyle({
                fillColor: "#3388ff",
                fillOpacity: 0.4
              });
              layer.bringToFront();
            },
            mouseout: function (e) {
              traviscountyLayer.resetStyle(e.target);
            },
            click: function (e) {
              var props = feature.properties;
              var csv = props.csv;

              var popupContent = "<strong>Precinct " + precinctNumber + "</strong>";
              if (csv && Object.keys(csv).length) {
                popupContent += "<br><strong>Chair:</strong> " + (csv["Precinct Chair Name"] || "Vacant");
                popupContent += "<br><strong>Email:</strong> " + (csv["Precinct Email"] || "N/A");
                popupContent += "<br><strong>Super Precinct:</strong> " + (csv["Super Precinct Name"] || "N/A");
              } else {
                popupContent += "<br><em>No data found</em>";
              }

              layer.bindPopup(popupContent).openPopup();
            }
          });
        }
      }).addTo(map);
    }
  });
</script>

</body>
</html>
